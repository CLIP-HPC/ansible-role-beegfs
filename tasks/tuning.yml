---
# BeeGFS tuning parameters
# from https://www.beegfs.io/wiki/StorageServerTuning
- name: BeeGFS tuning parameters
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
    sysctl_set: yes
  with_items:
  - {key: 'vm.dirty_background_ratio', value: '5'}
  - {key: 'vm.dirty_ratio', value: '20'}
  - {key: 'vm.vfs_cache_pressure', value: '50'}
  - {key: 'vm.min_free_kbytes', value: '262144'}
  - {key: 'vm.zone_reclaim_mode', value: '1'}
  become: yes

- name: Copy beegfs-tuning.sh to /opt/beegfs/
  template:
    src: beegfs-tuning.sh.j2
    dest: /opt/beegfs/beegfs-tuning.sh
    mode: a+x
  become: yes
  notify: Restart BeeGFS tuning service


- name: Copy beegfs-tuning.service to /etc/systemd/system/
  copy:
    src: beegfs-tuning.service
    dest: /etc/systemd/system/
  become: yes
  notify:
  - Restart BeeGFS tuning service

- name: Remove content from rc.local (remove once done)
  blockinfile:
    dest: /etc/rc.d/rc.local
    mode: a+x
    marker: "# {mark} BeeGFS tuning parameters"
    state: absent
    block: |
      # from https://www.beegfs.io/wiki/StorageServerTuning
      echo always > /sys/kernel/mm/transparent_hugepage/enabled
      echo always > /sys/kernel/mm/transparent_hugepage/defrag
      for dev in {{ beegfs_oss | map(attribute='dev') | join(' ') }}
      do
        echo mq-deadline > /sys/block/${dev}/queue/scheduler
        echo 2048 > /sys/block/${dev}/queue/nr_requests
        echo 4096 > /sys/block/${dev}/queue/read_ahead_kb
        echo 256 > /sys/block/${dev}/queue/max_sectors_kb
      done
  become: yes

- name: Disable rc-local (remove once done)
  service:
    name: rc-local
    enabled: no
  become: yes
...
